<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Vòng xoay kỷ niệm</title>
  <!-- Viewport CHUẨN cho mobile -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <style>
    :root{
      --arrow-size: 44px;
      --card-w: 320px;      /* PC */
      --card-h: 200px;      /* PC */
      --card-radius: 12px;
    }

    *{box-sizing:border-box}

    body {
      font-family: Arial, sans-serif;
      background: #f7f9fc;
      text-align: center;
      margin: 0;
      min-height: 100vh;
      overflow-x: hidden;
    }

    h1 {
      margin: 16px 0 8px;
      line-height: 1.2;
      z-index: 2;
      position: relative;
    }

    /* nền canvas */
    canvas { display: block; }
    #bg-canvas {
      position: fixed;
      inset: 0;
      z-index: -1;
      background: #fcf8f8;
      pointer-events: none;
    }

    /* khung sân khấu */
    .stage {
      width: 100%;
      height: 70vh;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
      overflow: hidden;
    }

    .carousel {
      width: 100%;
      height: 100%;
      perspective: 1500px;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: grab;
      user-select: none;
      touch-action: pan-y;
    }
    .carousel.dragging { cursor: grabbing; }

    .carousel-track {
      width: 100%;
      height: 100%;
      position: relative;
      transform-style: preserve-3d;
    }

    /* thẻ ảnh/video */
    .card {
      width: var(--card-w);
      height: var(--card-h);
      border-radius: var(--card-radius);
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
      text-align: center;
      position: absolute;
      top: 35%;
      left: 50%;
      transform: translateX(-50%);
      transition: transform 0.25s ease, opacity 0.25s ease;
      overflow: hidden;
      background:
        linear-gradient(rgba(0,0,0,0.12), rgba(0,0,0,0.12)),
        url("anh-nen-khung.jpg") center/cover no-repeat;
      padding: 10px;
      padding-top: 22px;
      padding-bottom: 50px;
    }

    .card img,
    .card video,
    .card iframe {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;    /* giữ tỉ lệ, không cắt */
      border-radius: 10px;
      display: block;
      margin: auto;
    }

    .caption {
      margin: 8px 0 0;
      font-weight: bold;
      color: #c02525;
      user-select: none;
    }

    /* nút mũi tên */
    .nav-btn {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: var(--arrow-size);
      height: var(--arrow-size);
      border: none;
      border-radius: 50%;
      background: rgba(0,0,0,0.5);
      color: #fff;
      font-size: 22px;
      display: grid;
      place-items: center;
      cursor: pointer;
      z-index: 10;
      transition: background .2s;
    }
    .nav-btn:hover{ background: rgba(0,0,0,0.7); }
    #prevBtn{ left: 12px; }
    #nextBtn{ right: 12px; }

    /* nhóm nút chọn ngày – cố định góc, không dính khối */
    .days {
      position: fixed;
      left: 12px;
      bottom: 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 20;
    }
    .day {
      padding: 10px 14px;
      background: #007bff;
      color: #fff;
      border-radius: 10px;
      cursor: pointer;
      border: none;
      font-size: 14px;
      font-weight: 700;
      box-shadow: 0 4px 10px rgba(0,0,0,0.25);
      white-space: nowrap;
    }
    .day:hover { background: #0056b3; }
    .day.active { background: #0a58ca; }

    /* Responsive cho mobile */
    @media (max-width: 768px){
      :root{
        --arrow-size: 38px;
        --card-w: min(92vw, 420px);
        --card-h: auto;       /* cho phép cao theo nội dung */
      }

      .card{
        top: 30%;
        padding-top: 14px;
      }

      .card img,
      .card video,
      .card iframe{
        height: auto;
        max-height: 58vh;     /* không vượt chiều cao màn hình */
      }

      .day{
        font-size: 13px;
        padding: 8px 12px;
      }
    }

    /* Rất nhỏ (điện thoại cỡ 360px) */
    @media (max-width: 400px){
      :root{ --arrow-size: 34px; }
      #prevBtn{ left: 6px; }
      #nextBtn{ right: 6px; }
    }
  </style>
</head>
<body>
  <!-- Nền canvas + chữ rơi -->
  <canvas id="bg-canvas"></canvas>

  <h1>Kỷ niệm của chúng tôi</h1>

  <div class="stage">
    <div class="carousel" id="carousel">
      <div class="carousel-track" id="track"></div>
    </div>

    <button class="nav-btn" id="prevBtn" aria-label="Trước">&#10094;</button>
    <button class="nav-btn" id="nextBtn" aria-label="Sau">&#10095;</button>
  </div>

  <!-- Nhóm nút NGÀY (đặt đúng cấu trúc, không lồng sai) -->
  <div class="days" id="days">
    <button class="day" data-media="
      1 (1).jpg, 1 (3).jpg, 1 (4).jpg, 1 (5).jpg, 1 (6).jpg,
      1 (7).jpg, 1 (8).jpg, 1 (9).jpg, 1 (10).jpg, 1 (11).jpg,
      1 (12).jpg, 1 (13).jpg, 1 (14).jpg, 1 (15).jpg, 1 (16).jpg,
      1 (17).jpg, 1 (18).jpg, 1 (19).jpg, 1 (20).jpg, 1 (21).jpg,
      1 (22).jpg, 1 (23).jpg, 1 (24).jpg, 1 (25).jpg, 1 (26).jpg,
      1 (27).jpg, 1 (28).jpg, 1 (29).jpg, 1 (30).jpg, 1 (31).jpg,
      1 (32).jpg, 1 (33).jpg, 1 (34).jpg, 1 (35).jpg, 1 (36).jpg,
      1 (37).jpg, 1 (38).jpg, 1 (39).jpg, 1 (40).jpg, 1 (41).jpg,
      1 (42).jpg, 1 (43).jpg, 1 (44).jpg, 1 (45).jpg, 1 (46).jpg,
      1 (47).jpg, 1 (48).jpg, 1 (49).jpg, 1 (50).jpg, 1 (51).jpg,
      1 (52).jpg, 1 (53).jpg, 1 (54).jpg, 1 (55).jpg, 1 (56).jpg, 1 (57).jpg
    ">Ảnh dìm banh nóc</button>

    <button class="day" data-media="
      day2/1.jpg, day2/2.jpg, day2/3.jpg, day2/4.jpg, day2/5.jpg,
      day2/6.jpg, day2/7.jpg, day2/8.jpg, day2/9.jpg, day2/10.jpg,
      day2/11.jpg, day2/12.jpg, day2/13.jpg, day2/14.jpg, day2/15.jpg,
      day2/16.jpg, day2/17.jpg, day2/18.jpg, day2/19.jpg, day2/20.jpg, day2/21.jpg
    ">Ảnh tâm tình</button>
  </div>

  <script>
    /* ===================== 3D CAROUSEL ===================== */
    const track   = document.getElementById("track");
    const dayEls  = document.querySelectorAll(".day");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const carousel= document.getElementById("carousel");

    const isImage = src => /\.(jpe?g|png|gif|webp|avif)$/i.test(src.trim());
    const isVideo = src => /\.(mp4|webm|ogg)$/i.test(src.trim());

    let list = [];
    let angle = 0;
    let startX = 0;
    let isDragging = false;

    const getRadius = () => {
      // bán kính phụ thuộc kích thước màn hình (đẹp trên mobile)
      const base = Math.min(window.innerWidth, 1200);
      return Math.max(380, base * 0.75);
    };

    function makeMediaEl(src) {
      if (isImage(src)) {
        const img = document.createElement("img");
        img.loading = "lazy";
        img.src = src.trim();
        return img;
      } else if (isVideo(src)) {
        const vid = document.createElement("video");
        vid.src = src.trim();
        vid.playsInline = true;
        vid.muted = true;
        vid.loop = true;
        vid.autoplay = true;
        return vid;
      }
      const t = document.createElement("div");
      t.textContent = "Không hỗ trợ: " + src;
      t.style.color = "crimson";
      t.style.fontWeight = "700";
      return t;
    }

    function renderCards() {
      track.innerHTML = "";
      if (!list.length) return;

      list.forEach(src => {
        const card  = document.createElement("div");
        card.className = "card";
        card.appendChild(makeMediaEl(src));
        const p = document.createElement("p");
        p.className = "caption";
        p.textContent = "";           // nếu muốn caption thì điền ở đây
        card.appendChild(p);
        track.appendChild(card);
      });

      updatePositions();
    }

    function updatePositions() {
      const cards = track.querySelectorAll(".card");
      const total = cards.length;
      const radius = getRadius();

      cards.forEach((card, i) => {
        const theta = (360 / total) * i + angle;
        const norm = (theta % 360 + 360) % 360;   // 0..359
        const rad  = theta * Math.PI / 180;

        const x = Math.sin(rad) * radius;
        const z = Math.cos(rad) * radius;

        let scale = 0.82;
        let opacity = 0.25;
        let zIndex = Math.floor(z);

        // trung tâm màn hình
        if (norm < 15 || norm > 345) {
          scale = 1.35;
          opacity = 1;
          zIndex = 1000;
        }

        card.style.transform = `translateX(${x}px) translateZ(${z}px) scale(${scale})`;
        card.style.opacity = opacity;
        card.style.zIndex = zIndex;

        const video = card.querySelector("video");
        if (video){
          if (scale > 1.0) { video.muted = false; video.play().catch(()=>{}); }
          else { video.pause(); video.muted = true; }
        }
      });
    }

    // chọn ngày
    dayEls.forEach(d => {
      d.addEventListener("click", () => {
        dayEls.forEach(x => x.classList.remove("active"));
        d.classList.add("active");
        list = (d.getAttribute("data-media") || "")
          .split(",")
          .map(s => s.trim())
          .filter(Boolean);
        angle = 0;
        renderCards();
      });
    });

    // mặc định chọn cái đầu tiên có media
    (function selectFirstDay(){
      for (const d of dayEls) {
        if ((d.getAttribute('data-media')||'').trim()){
          d.click();
          break;
        }
      }
    })();

    // Drag xoay
    document.addEventListener("mousedown", e => {
      isDragging = true; startX = e.clientX; carousel.classList.add('dragging');
    });
    document.addEventListener("mousemove", e => {
      if (!isDragging) return;
      const deltaX = e.clientX - startX;
      angle += deltaX * 0.12;
      updatePositions();
      startX = e.clientX;
    });
    document.addEventListener("mouseup", () => {
      isDragging = false; carousel.classList.remove('dragging');
    });

    document.addEventListener("touchstart", e => {
      isDragging = true; startX = e.touches[0].clientX; carousel.classList.add('dragging');
    }, {passive:true});
    document.addEventListener("touchmove", e => {
      if (!isDragging) return;
      const deltaX = e.touches[0].clientX - startX;
      angle += deltaX * 0.32;
      updatePositions();
      startX = e.touches[0].clientX;
    }, {passive:true});
    document.addEventListener("touchend", () => {
      isDragging = false; carousel.classList.remove('dragging');
    });

    // bấm mũi tên
    nextBtn.addEventListener('click', () => {
      if (!list.length) return;
      angle -= 360 / list.length;
      updatePositions();
    });
    prevBtn.addEventListener('click', () => {
      if (!list.length) return;
      angle += 360 / list.length;
      updatePositions();
    });

    // click thẻ để đưa ra giữa
    track.addEventListener("click", e => {
      const card = e.target.closest(".card");
      if (!card) return;
      const cards = [...track.querySelectorAll(".card")];
      const idx = cards.indexOf(card);
      if (idx === -1) return;
      angle = -(360 / cards.length) * idx;
      updatePositions();
    });

    // khi đổi kích thước màn hình => căn lại vị trí
    window.addEventListener("resize", updatePositions);

    /* ===================== NỀN CHỮ RƠI ===================== */
    const canvas = document.getElementById("bg-canvas");
    const ctx = canvas.getContext("2d");

    function resizeCanvas(){
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    resizeCanvas();

    const texts = [
      "AL Bá Gia Lai",
      "Mời Cả Nhà Ăn Cơm",
      "8h họp đội hình nha mọi người ơi"
    ];

    const bgImage = new Image();
    bgImage.src = "anh-nen-pon.jpg";

    const falling = [];
    const maxLetters = 5;

    class FallingText {
      constructor(text){
        this.text = text;
        this.x = Math.random() * (canvas.width - 200);
        this.y = -50;
        this.speed = 1.2 + Math.random() * 1.4;
        this.fontSize = 24 + Math.random() * 8;
      }
      draw(){
        ctx.font = `${this.fontSize}px Arial`;
        ctx.fillStyle = "rgba(180,255,120,0.95)";
        ctx.fillText(this.text, this.x, this.y);
        this.y += this.speed;
      }
    }

    function animateBG(){
      // vẽ nền (nếu có ảnh thì vẽ, không thì fill)
      if (bgImage.complete) {
        ctx.drawImage(bgImage, 0, 0, canvas.width, canvas.height);
      } else {
        ctx.fillStyle = "#fcf8f8";
        ctx.fillRect(0,0,canvas.width,canvas.height);
      }

      if (falling.length < maxLetters && Math.random() > 0.97){
        const t = texts[Math.floor(Math.random()*texts.length)];
        falling.push(new FallingText(t));
      }

      for (let i = falling.length - 1; i >= 0; i--){
        const ft = falling[i];
        ft.draw();
        if (ft.y > canvas.height + 60){
          falling.splice(i,1);
        }
      }
      requestAnimationFrame(animateBG);
    }
    bgImage.onload = animateBG;
    if (bgImage.complete) animateBG();

    window.addEventListener("resize", () => {
      resizeCanvas();
      updatePositions();
    });
  </script>
</body>
</html>
